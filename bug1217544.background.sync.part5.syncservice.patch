# HG changeset patch
# User Fernando Jimenez <ferjmoreno@gmail.com>
# Parent  2897cb942c87081c44e23028f0f4849363ce708c
Bug 1217544 - Implement one-off BackgroundSync API. Part 5: SyncService. r=baku

diff --git a/dom/sync/SyncManagerParent.cpp b/dom/sync/SyncManagerParent.cpp
--- a/dom/sync/SyncManagerParent.cpp
+++ b/dom/sync/SyncManagerParent.cpp
@@ -1,49 +1,62 @@
 /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
 /* vim: set ts=8 sts=2 et sw=2 tw=80: */
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
  * You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "SyncManagerParent.h"
+#include "SyncService.h"
 
 #include "mozilla/unused.h"
 #include "mozilla/ipc/BackgroundParent.h"
 
 namespace mozilla {
 
 using namespace ipc;
 
 namespace dom {
 
 SyncManagerParent::SyncManagerParent()
+  : mService(SyncService::GetOrCreate())
 {
   AssertIsOnBackgroundThread();
+  mService->RegisterActor(this);
 }
 
 SyncManagerParent::~SyncManagerParent()
 {
   AssertIsOnBackgroundThread();
 }
 
 void SyncManagerParent::ActorDestroy(ActorDestroyReason aWhy)
 {
   AssertIsOnBackgroundThread();
+
+  if (mService) {
+    mService->UnregisterActor(this);
+  }
 }
 
 bool SyncManagerParent::RecvRequest(const nsID& aRequestId,
                                     const SyncOp& aOp)
 {
   AssertIsOnBackgroundThread();
 
+  if (NS_WARN_IF(!mService)) {
+    return false;
+  }
+
   switch(aOp.mArgs().type()) {
     case SyncOpArgs::TSyncRegisterArgs:
     {
-      // XXX Do registration.
+      // XXX this needs to be async
+      mService->Register(aOp.mPrincipal(),
+          aOp.mArgs().get_SyncRegisterArgs().mTag());
       const SyncRegisterResponse response(true);
       //const SyncOpError response(static_cast<uint32_t>(NS_ERROR_FAILURE));
       Unused << SendResponse(aRequestId, response);
       break;
     }
     case SyncOpArgs::TSyncGetTagsArgs:
     {
       //XXX Do GetTags.
@@ -59,15 +72,19 @@ bool SyncManagerParent::RecvRequest(cons
   }
   return true;
 }
 
 bool SyncManagerParent::RecvShutdown()
 {
   AssertIsOnBackgroundThread();
 
+  if (NS_WARN_IF(!mService)) {
+    return false;
+  }
+
   Unused << Send__delete__(this);
 
   return true;
 }
 
 } // namespace dom
 } // namespace mozilla
diff --git a/dom/sync/SyncManagerParent.h b/dom/sync/SyncManagerParent.h
--- a/dom/sync/SyncManagerParent.h
+++ b/dom/sync/SyncManagerParent.h
@@ -15,30 +15,34 @@
 namespace mozilla {
 
 namespace ipc {
 class BackgroundParentImpl;
 } // namespace ipc
 
 namespace dom {
 
+class SyncService;
+
 class SyncManagerParent final : public PSyncManagerParent
 {
   friend class mozilla::ipc::BackgroundParentImpl;
 
 public:
   virtual bool RecvRequest(const nsID& aRequestId,
                            const SyncOp& aOp) override;
 
   virtual bool RecvShutdown() override;
 private:
   SyncManagerParent();
   ~SyncManagerParent();
 
   virtual void ActorDestroy(ActorDestroyReason aWhy) override;
+
+  RefPtr<SyncService> mService;
 };
 
 } // namespace dom
 } // namespace mozilla
 
 #endif // mozilla_dom_SyncManagerParent_h
 
 
diff --git a/dom/sync/SyncService.cpp b/dom/sync/SyncService.cpp
new file mode 100644
--- /dev/null
+++ b/dom/sync/SyncService.cpp
@@ -0,0 +1,85 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#include "SyncService.h"
+#include "SyncManagerParent.h"
+
+namespace mozilla {
+
+namespace dom {
+
+namespace {
+  SyncService* sInstance = nullptr;
+} // namespace
+
+SyncService::SyncService()
+{
+  AssertIsOnBackgroundThread();
+
+  // sInstance is a raw SyncService*.
+  MOZ_ASSERT(!sInstance);
+  sInstance = this;
+}
+
+SyncService::~SyncService()
+{
+  AssertIsOnBackgroundThread();
+  MOZ_ASSERT(sInstance == this);
+  MOZ_ASSERT(mActors.Count() == 0);
+
+  sInstance = nullptr;
+}
+
+// static
+already_AddRefed<SyncService>
+SyncService::GetOrCreate()
+{
+  AssertIsOnBackgroundThread();
+
+  RefPtr<SyncService> instance = sInstance;
+  if (!instance) {
+    instance = new SyncService();
+  }
+  return instance.forget();
+}
+
+void
+SyncService::RegisterActor(SyncManagerParent* aParent)
+{
+  AssertIsOnBackgroundThread();
+  MOZ_ASSERT(aParent);
+  MOZ_ASSERT(!mActors.Contains(aParent));
+
+  mActors.PutEntry(aParent);
+}
+
+void
+SyncService::UnregisterActor(SyncManagerParent* aParent)
+{
+  AssertIsOnBackgroundThread();
+  MOZ_ASSERT(aParent);
+  MOZ_ASSERT(mActors.Contains(aParent));
+
+  mActors.RemoveEntry(aParent);
+}
+
+bool
+SyncService::Register(const PrincipalInfo& aPrincipal,
+                      const nsString& aTag)
+{
+  // XXX implement me.
+  return true;
+}
+
+void
+SyncService::GetTags(const PrincipalInfo& aPrincipal,
+                     nsTArray<nsString>& aTags)
+{
+  // XXX implement me.
+}
+
+} // namespace dom
+} // namespace mozilla
diff --git a/dom/sync/SyncService.h b/dom/sync/SyncService.h
new file mode 100644
--- /dev/null
+++ b/dom/sync/SyncService.h
@@ -0,0 +1,42 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef mozilla_dom_SyncService_h
+#define mozilla_dom_SyncService_h
+
+#include "nsISupportsImpl.h"
+#include "nsHashKeys.h"
+#include "nsTHashtable.h"
+
+namespace mozilla {
+namespace dom {
+
+class SyncManagerParent;
+
+class SyncService final
+{
+public:
+  NS_INLINE_DECL_REFCOUNTING(SyncService)
+
+  static already_AddRefed<SyncService> GetOrCreate();
+
+  void RegisterActor(SyncManagerParent* aParent);
+  void UnregisterActor(SyncManagerParent* aParent);
+
+  bool Register(const PrincipalInfo& aPrincipal, const nsString& aTag);
+  void GetTags(const PrincipalInfo& aPrincipal, nsTArray<nsString>& aTags);
+
+private:
+  SyncService();
+  ~SyncService();
+
+  nsTHashtable<nsPtrHashKey<SyncManagerParent>> mActors;
+};
+
+} // namespace dom
+} // namespace mozilla
+
+#endif // mozilla_dom_SyncService_h
diff --git a/dom/sync/moz.build b/dom/sync/moz.build
--- a/dom/sync/moz.build
+++ b/dom/sync/moz.build
@@ -5,17 +5,18 @@
 
 EXPORTS.mozilla.dom += [
     'SyncManager.h'
 ]
 
 UNIFIED_SOURCES += [
     'SyncManager.cpp',
     'SyncManagerChild.cpp',
-    'SyncManagerParent.cpp'
+    'SyncManagerParent.cpp',
+    'SyncService.cpp'
 ]
 
 IPDL_SOURCES += [
     'PSyncManager.ipdl',
     'SyncIPCTypes.ipdlh'
 ]
 
 LOCAL_INCLUDES += [
