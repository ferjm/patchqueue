# HG changeset patch
# User Fernando Jimenez <ferjmoreno@gmail.com>
# Parent  3fadaa78105c538723e3e298a295070103451c1e
try: -b o -p win32 -u none -t none

diff --git a/dom/backgroundsync/BackgroundSyncChild.cpp b/dom/backgroundsync/BackgroundSyncChild.cpp
--- a/dom/backgroundsync/BackgroundSyncChild.cpp
+++ b/dom/backgroundsync/BackgroundSyncChild.cpp
@@ -1,16 +1,17 @@
 /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
 /* vim: set ts=8 sts=2 et sw=2 tw=80: */
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
  * You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "BackgroundSyncChild.h"
 
+#include "mozilla/dom/Promise.h"
 #include "mozilla/Unused.h"
 #include "mozilla/ipc/PBackgroundChild.h"
 #include "nsContentUtils.h"
 
 namespace mozilla {
 
 using namespace ipc;
 
diff --git a/dom/backgroundsync/BackgroundSyncService.cpp b/dom/backgroundsync/BackgroundSyncService.cpp
--- a/dom/backgroundsync/BackgroundSyncService.cpp
+++ b/dom/backgroundsync/BackgroundSyncService.cpp
@@ -18,21 +18,24 @@
 
 #include "BackgroundSyncService.h"
 #include "ChromeStorageManager.h"
 #include "StorageManager.h"
 
 #include "mozilla/ipc/BackgroundUtils.h"
 #include "nsContentUtils.h"
 #include "nsIScriptSecurityManager.h"
+#include "ServiceWorkerManagerParent.h"
 
 namespace mozilla {
 namespace dom {
 namespace backgroundsync {
 
+using mozilla::dom::workers::ServiceWorkerManagerParent;
+
 namespace {
 BackgroundSyncService* sInstance = nullptr;
 } // namespace
 
 // ----------------------------------------------------------------------------
 
 class GetStorageManagerRunnable final : public CancelableRunnable
 {
diff --git a/dom/backgroundsync/BackgroundSyncTypes.h b/dom/backgroundsync/BackgroundSyncTypes.h
--- a/dom/backgroundsync/BackgroundSyncTypes.h
+++ b/dom/backgroundsync/BackgroundSyncTypes.h
@@ -2,21 +2,16 @@
 /* vim: set ts=8 sts=2 et sw=2 tw=80: */
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #ifndef mozilla_dom_BackgroundSyncTypes_h
 #define mozilla_dom_BackgroundSyncTypes_h
 
-#include <stdint.h>
-#include "nsCOMPtr.h"
-#include "nsIFile.h"
-#include "nsString.h"
-
 namespace mozilla {
 namespace dom {
 namespace backgroundsync {
 
 enum RegistrationState
 {
   ePending = 1,
   eWaiting,
diff --git a/dom/backgroundsync/ChromeStorageManager.cpp b/dom/backgroundsync/ChromeStorageManager.cpp
--- a/dom/backgroundsync/ChromeStorageManager.cpp
+++ b/dom/backgroundsync/ChromeStorageManager.cpp
@@ -12,16 +12,17 @@
 #include "nsIThread.h"
 #include "nsThreadUtils.h"
 
 namespace mozilla {
 namespace dom {
 namespace backgroundsync {
 
 using mozilla::ipc::AssertIsOnBackgroundThread;
+using workers::AssertIsOnMainThread;
 
 namespace {
   ChromeStorageManager* csmInstance = nullptr;
 } // namespace
 
 //-----------------------------------------------------------------------------
 
 class ChromeStorageAction
diff --git a/dom/backgroundsync/OnlineStateObserver.cpp b/dom/backgroundsync/OnlineStateObserver.cpp
--- a/dom/backgroundsync/OnlineStateObserver.cpp
+++ b/dom/backgroundsync/OnlineStateObserver.cpp
@@ -7,16 +7,18 @@
 #include "OnlineStateObserver.h"
 
 #include "mozilla/ipc/BackgroundParent.h"
 #include "nsIOService.h"
 
 namespace mozilla {
 namespace dom {
 
+using workers::AssertIsOnMainThread;
+
 /**
  * ShutdownRunnable
  */
 class ShutdownRunnable final : public Runnable
 {
 public:
   explicit ShutdownRunnable(OnlineStateObserver* aObserver)
     : mObserver(aObserver)
diff --git a/dom/backgroundsync/StorageManagerId.cpp b/dom/backgroundsync/StorageManagerId.cpp
--- a/dom/backgroundsync/StorageManagerId.cpp
+++ b/dom/backgroundsync/StorageManagerId.cpp
@@ -3,16 +3,17 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "StorageManagerId.h"
 
 #include "mozilla/ipc/BackgroundParent.h"
 #include "mozilla/dom/quota/QuotaManager.h"
+#include "nsProxyRelease.h"
 
 namespace mozilla {
 namespace dom {
 namespace backgroundsync {
 
 /**
  * StorageManagerIdFactory
  */
diff --git a/dom/backgroundsync/moz.build b/dom/backgroundsync/moz.build
--- a/dom/backgroundsync/moz.build
+++ b/dom/backgroundsync/moz.build
@@ -6,30 +6,33 @@
 EXPORTS.mozilla.dom.backgroundsync += [
     'BackgroundSync.h',
     'BackgroundSyncService.h',
     'BackgroundSyncTypes.h',
     'QuotaClient.h'
 ]
 
 UNIFIED_SOURCES += [
-    'BackgroundSync.cpp',
     'BackgroundSyncChild.cpp',
     'BackgroundSyncParent.cpp',
     'BackgroundSyncService.cpp',
     'ChromeDBSchema.cpp',
     'ChromeStorageManager.cpp',
     'DBAction.cpp',
     'DBSchema.cpp',
     'OnlineStateObserver.cpp',
     'QuotaClient.cpp',
     'StorageManager.cpp',
     'StorageManagerId.cpp'
 ]
 
+SOURCES += [
+    'BackgroundSync.cpp'
+]
+
 IPDL_SOURCES += [
     'BackgroundSyncIPCTypes.ipdlh',
     'PBackgroundSync.ipdl'
 ]
 
 MOCHITEST_MANIFESTS += [
     'tests/mochitest.ini'
 ]
