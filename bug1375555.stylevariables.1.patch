# HG changeset patch
# User Fernando Jimenez Moreno <ferjmoreno@gmail.com>
# Parent  4935b9338ba95ac5019451ee6859cc5e18117415
Bug 1375555 - Part 3: Implement indexed getter for custom property names. r?emilio

diff --git a/layout/style/ServoBindingList.h b/layout/style/ServoBindingList.h
--- a/layout/style/ServoBindingList.h
+++ b/layout/style/ServoBindingList.h
@@ -548,16 +548,20 @@ SERVO_BINDING_FUNC(Servo_SerializeFontVa
 // Get custom property value.
 SERVO_BINDING_FUNC(Servo_GetCustomPropertyValue, bool,
                    ServoComputedValuesBorrowed computed_values,
                    const nsAString* name, nsAString* value)
 
 SERVO_BINDING_FUNC(Servo_GetCustomPropertiesCount, uint32_t,
                    ServoComputedValuesBorrowed computed_values)
 
+SERVO_BINDING_FUNC(Servo_GetCustomPropertyNameAt, bool,
+                   ServoComputedValuesBorrowed, uint32_t index,
+                   nsAString* name)
+
 // Style-struct management.
 #define STYLE_STRUCT(name, checkdata_cb)                            \
   struct nsStyle##name;                                             \
   SERVO_BINDING_FUNC(Servo_GetStyle##name, const nsStyle##name*,  \
                      ServoComputedValuesBorrowedOrNull computed_values)
 #include "nsStyleStructList.h"
 #undef STYLE_STRUCT
 
diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -1067,21 +1067,36 @@ nsComputedDOMStyle::IndexedGetter(uint32
   // Custom properties are exposed with indexed properties just after all
   // of the built-in properties.
   UpdateCurrentStyleSources(false);
   if (!mStyleContext) {
     aFound = false;
     return;
   }
 
-  const nsStyleVariables* variables = StyleVariables();
-  if (aIndex - length < variables->mVariables.Count()) {
+  bool isServo = mStyleContext->IsServo();
+
+  const nsStyleVariables* variables = isServo
+    ? StyleVariables()
+    : nullptr;
+
+  const uint32_t count = isServo
+    ? Servo_GetCustomPropertiesCount(mStyleContext->ComputedValues())
+    : variables->mVariables.Count();
+
+  const uint32_t index = aIndex - length;
+  if (index < count) {
     aFound = true;
     nsString varName;
-    variables->mVariables.GetVariableAt(aIndex - length, varName);
+    if (isServo) {
+      Servo_GetCustomPropertyNameAt(mStyleContext->ComputedValues(),
+                                    index, &varName);
+    } else {
+      variables->mVariables.GetVariableAt(index, varName);
+    }
     aPropName.AssignLiteral("--");
     aPropName.Append(varName);
   } else {
     aFound = false;
   }
 
   ClearCurrentStyleSources();
 }
diff --git a/servo/components/style/custom_properties.rs b/servo/components/style/custom_properties.rs
--- a/servo/components/style/custom_properties.rs
+++ b/servo/components/style/custom_properties.rs
@@ -102,20 +102,31 @@ pub struct CustomPropertiesMap {
     /// Custom property name index.
     index: Vec<Name>,
     /// Computed values indexed by custom property name.
     values: HashMap<Name, ComputedValue>,
 }
 
 impl CustomPropertiesMap {
     /// Custom property computed value getter by name.
-    pub fn get(&self, name: Atom) -> Option<&ComputedValue> {
+    pub fn get_computed_value(&self, name: Atom) -> Option<&ComputedValue> {
         self.values.get(&(name as Name))
     }
 
+    /// Get the name of a custom property given its list index.
+    pub fn get_name_at(&self, index: u32) -> Option<&Name>
+    {
+        let index = index as usize;
+        if index >= self.len() {
+            return None;
+        }
+
+        Some(&self.index[index])
+    }
+
     /// Get the count of custom properties computed values.
     pub fn len(&self) -> usize {
         debug_assert!(self.values.len() == self.index.len());
         self.values.len()
     }
 }
 
 impl ComputedValue {
diff --git a/servo/ports/geckolib/glue.rs b/servo/ports/geckolib/glue.rs
--- a/servo/ports/geckolib/glue.rs
+++ b/servo/ports/geckolib/glue.rs
@@ -3130,24 +3130,42 @@ pub extern "C" fn Servo_StyleSet_HasStat
 pub extern "C" fn Servo_GetCustomPropertyValue(computed_values: ServoComputedValuesBorrowed,
                                                name: *const nsAString, value: *mut nsAString) -> bool {
     let custom_properties = match ComputedValues::as_arc(&computed_values).custom_properties() {
         Some(p) => p,
         None => return false,
     };
 
     let name = unsafe { Atom::from((&*name)) };
-    let computed_value = match custom_properties.get(name) {
+    let computed_value = match custom_properties.get_computed_value(name) {
         Some(v) => v,
         None => return false,
     };
 
     computed_value.to_css(unsafe { value.as_mut().unwrap() }).unwrap();
     true
 }
 
 #[no_mangle]
 pub extern "C" fn Servo_GetCustomPropertiesCount(computed_values: ServoComputedValuesBorrowed) -> u32 {
     match ComputedValues::as_arc(&computed_values).custom_properties() {
         Some(p) => p.len() as u32,
         None => 0,
     }
 }
+
+#[no_mangle]
+pub extern "C" fn Servo_GetCustomPropertyNameAt(computed_values: ServoComputedValuesBorrowed,
+                                                index: u32, name: *mut nsAString) -> bool {
+    let custom_properties = match ComputedValues::as_arc(&computed_values).custom_properties() {
+        Some(p) => p,
+        None => return false,
+    };
+
+    let name = unsafe { name.as_mut().unwrap() };
+    let property_name = match custom_properties.get_name_at(index) {
+        Some(n) => n,
+        None => return false,
+    };
+    name.assign_utf8(&property_name.to_string());
+
+    true
+}
